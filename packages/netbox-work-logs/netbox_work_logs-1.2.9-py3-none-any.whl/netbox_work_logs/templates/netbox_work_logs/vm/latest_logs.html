{% load static %}

<div class="panel panel-default">
    <div class="panel-heading">
        <strong>Virtual Machine Work Logs</strong>
    </div>
    
    <table id="vwl_table" class="table table-hover table-headings panel-body component-list">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Subject</th>
                <th>Category</th>
                <th>Content</th>
            </tr>
        </thead>
        <tbody>
        {% for log in work_logs %}
            {% include 'netbox_work_logs/vm/inc/logs.html' %}
        {% empty %}
            <tr>
                <td colspan="8" class="text-center text-muted">&mdash; No Worked Logs &mdash;</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% comment %} <form id="vwl_form" name="vwl_form" enctype="multipart/form-data" class="form form-horizontal"> {% endcomment %}
    <form id="vwl_form" name="vwl_form" enctype="multipart/form-data" class="form form-horizontal" method="post" action="">
        {% csrf_token %}
        <div class="panel-body">
                <div class="form-group">
                    <label class="col-md-3 control-label" for="vwl_category"> Category</label>
                    <div class="col-md-9">
                        <select id="vwl_category" name="vwl_category" 
                            class="netbox-select2-api form-control select2-hidden-accessible" 
                            data-url="/api/plugins/work-logs/categories/"
                            display-field="category" required>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label" for="vwl_subject"> Subject</label>
                    <div class="col-md-9">
                        <input type="text" name="vwl_subject" id="vwl_subject" class="form-control" placeholder="Subject" maxlength="64" required/>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label" for="vwl_content"> Work Log Content</label>
                    <div class="col-md-9">
                        <textarea name="vwl_content" id="vwl_content"  style="height: 100px;" class="form-control" placeholder="Work Log Content" ></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-9 col-md-offset-3">
                        <div class="checkbox">
                            <label for="vwl_internal_only">
                                <input type="checkbox" name="vwl_internal_only" id="vwl_internal_only" /> Internal Only
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label" for="vwl_ticket_id"> Ticket ID</label>
                    <div class="col-md-9">
                        <input type="text" name="vwl_ticket_id" id="vwl_ticket_id" class="form-control" placeholder="Ticket ID" maxlength="64"/>
                    </div>
                </div>
                <input type="hidden" id="vm" name="vm" value="{{ object.id }}">
                <input type="hidden" id="user" name="user" value="{{ request.user.id }}">
        </div>
        <div class="panel-footer text-right noprint">
            {% comment %} <button type="button" class="btn btn-xs btn-primary" id="btn_vwl" name="btn_vwl">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Submit Log
            </button> {% endcomment %}
            <button type="button" class="btn btn-xs btn-primary" id="btn_vwl" name="btn_vwl">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Submit Log
            </button>
        </div>
    </form>
</div>

<script src="{% static 'jquery/jquery-3.5.1.min.js' %}"></script>
<script type="text/javascript">
$(document).ready(function(){
    $("#btn_vwl").click(function(){
        //console.log("form submit");
        //$("#vwl_form")[0].submit(function(e){

            var url = netbox_api_path + "plugins/work-logs/vm-logs/";

            if ($('#vwl_category').val() == "") {
                alert ("Category field is a required field")
                return false;
            } else {
                var vwl_category = $('#vwl_category').val();
            }
            
            if ($('#vwl_subject').val() == "") {
                alert ("Subject field is a required field");
                return false;
            } else {
                var vwl_subject = $('#vwl_subject').val();
            }
            
            var vwl_content = $('#vwl_content').val();
            var vwl_internal_only = $('#vwl_internal_only').val();
            var vm = $('#vm').val();
            var author = $('#user').val();
            var vwl_ticket_id = $('#vwl_ticket_id').val();
            var csrf_token = $('input[name=csrfmiddlewaretoken]').val();
            $.ajax({
                url: url,
                method: 'POST',
                dataType: 'json',
                data: {
                    'vm': vm,
                    'user': author,
                    'category': vwl_category,
                    'subject': vwl_subject,
                    'content': vwl_content,
                    'internal_only': vwl_internal_only,
                    'ticket_id':vwl_ticket_id,
                },
                beforeSend: function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", csrf_token);
                },
                success: function(result) {
                    alert("Worked Logs saved successfully!")
                    window.location.reload(false);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    if (xhr.status == 403) {
                        alert("Permission denied");
                    } else {
                        alert(xhr.responseText)
                        //var json = jQuery.parseJSON(xhr.responseText);
                        //alert("Failed to retrieve a session key: " + json['error']);
                    }
                }
            })

            
        //})
    })
})
</script>

