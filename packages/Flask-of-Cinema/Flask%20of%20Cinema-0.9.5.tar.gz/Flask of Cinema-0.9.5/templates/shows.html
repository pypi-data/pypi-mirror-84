{% extends "flexbox.html"%}

{% block flexcontent %}
    {% if action == 'add' %}
    {% set days=['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
    <script>
        var days_subforms = {

            {% for day in days %}
                {{day}}: 0,
            {% endfor %}
        };

        function addTime(day){
            document.getElementById(day + "-subform").insertAdjacentHTML('beforeend',`
                <div id="${day}${days_subforms[day]}" style="background-color: #F0F0F0; padding: 4px; border-radius: 4px; margin-bottom: 8px;">
                    <div class="input-field">
                        <input type="text" class="timepicker" name="${day}-hour[]" required>
                        <label for="${day}-hour[]">Orario</label>
                    </div>
                    <select name="${day}-theater[]" required>
                    <option value="" disabled selected hidden>Sala</option>
                        {% for theater in theaters %}
                            <option value="{{'%s'%theater.id}}">{{theater.name}}</option>
                        {% endfor %}
                    </select>
                </div>
            `)
            if(days_subforms[day] == 0)
                document.getElementById(day+'-div').insertAdjacentHTML('beforeend', `
                    <button id="${day}-remove-time" class="btn waves-effect waves-light red" type="button" onclick="removeTime('${day}'); return false;"><i class="material-icons">delete</i></button>
                `)
            initSelect();
            initTimePicker();
            days_subforms[day]++;
        }

        function removeTime(day){
            var elem = document.querySelector('#'+day+(days_subforms[day]-1));
            elem.parentNode.removeChild(elem);
            if(days_subforms[day] == 1){
                var remove = document.querySelector('#'+day+'-remove-time');
                remove.parentNode.removeChild(remove);
            }
            days_subforms[day]--;
        }
    </script>

    <form action="/shows/{{film_id}}" method="POST" style="width: 100%">
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-content">
                    <div class="card-title"><div class="teal-text" style="font-weight: 500">{{film_name}}</div> Nuove proiezioni</div>
                    <div style="display: flex; align-items: center">
                        <div class="input-field">
                            <input name="price" type="number" step="0.01" required>
                            <label for="price">Prezzo</label>
                        </div>
                        <div class="input-field" style="margin-left: 8px;">
                            <input name="date_start" type="text" class="datepicker" placeholder="Da" required>
                            <label for="price">Da</label>
                        </div>
                        <div class="input-field">
                            <input name="date_end" style="margin-left: 8px;" type="text" class="datepicker" placeholder="A" required>
                            <label for="price">A</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-content">
                    <div class="card-title">Orari</div>
                    <div class="row" style="flex-direction: row; align-items: flex-start">
                    {% for day in days %}
                    <div class="col" style="margin-left: 8px;" id="{{day}}-div">
                        <h6>{{day}}</h6>
                        <div id="{{day}}-subform">
                        </div>
                        <button type="button" class="btn waves-effect waves-light" onclick="addTime('{{day}}'); return false;"><i class="material-icons">add</i></button>
                    </div>
                    {% endfor %}
                    </div>
                    <div class="card-action center-align">
                        <button type="submit" class="btn waves-effect waves-light" value="aggiungi">Aggiungi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </form>
    {% else %}
    <div class="row">
        <div class="col">
            <div class="card-panel">
                <form action="{{'/shows/%s'%(film_id|string)|urlencode}}" method="GET" style="display: flex; align-items: center;">
                    <div class="input-field">
                        <input name="date_start" type="text" class="datepicker">
                        <label for="date_start">Da<label>
                    </div>
                    <div class="input-field" style="margin-left: 8px;">
                        <input name="date_end" type="text" class="datepicker">
                        <label for="date_end">A</label>
                    </div>
                    <button class="btn waves-effect waves-light" type="submit" style="margin-left: 8px;">Filtra</button>
                </form>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-image">
                {% if role == 'MANAGER' %}
                    <a class="btn-floating halfway-fab waves-effect waves-light red" href="/shows/{{film_id}}?action=add"><i class="material-icons">add</i></a>
                {% endif %}
                </div>
                <div class="card-content">
                    {% if shows and ((shows | length) > 0) %}
                    <span class="card-title">Lista proiezioni {{film_name}}</span>
                    <span class="card-subtitle">Clicca sul + per aggiungere delle proiezioni</span>
                    <ul class="collection">
                        {% for show in shows %}
                        <li class="collection-item" style="display: flex">
                            <div style="flex:1">
                                <h6 style="display: flex; align-items:center;"><i class="material-icons">today</i>&nbsp;{{show.date.strftime("%d/%m/%Y")}}</h6>
                                <div style="display: flex; align-items:center;"><i class="material-icons">access_time</i>&nbsp;{{show.date.strftime("%H:%M")}}
                                <i class="material-icons" style="margin-left: 16px;">room</i>&nbsp;{{show.theaterName}}</div>
                            </div>
                            {% if show.isDeletable %}
                            <form method="POST" id="delete-{{show.id}}" action="/delete-show">
                                <a href="#" onclick="document.getElementById('delete-{{show.id}}').submit(); return false;" class="secondary-content"><i class="material-icons" style="color:red">delete</i></a>
                                <input name="id" type="hidden" value="{{show.id}}" />
                                <input name="idFilm" type="hidden" value="{{film_id}}" />
                            </form>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                        <div>Non esistono ancora proiezioni per {{film_name}}</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
{% endblock %}